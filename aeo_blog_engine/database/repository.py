from typing import Optional

from .models import Blog


def get_blog_by_user_and_company(session, *, user_id: str, company_url: str) -> Optional[Blog]:
    return (
        session.query(Blog)
        .filter(Blog.user_id == user_id, Blog.company_url == company_url)
        .order_by(Blog.created_at.desc())
        .first()
    )


def create_blog_entry(
    session,
    *,
    user_id: str,
    topic: str,
    company_url: str,
    email_id: str = None,
    brand_name: str = None,
    blog: Optional[str] = None,
    status: str = "PENDING",
    twitter_post: Optional[str] = None,
    linkedin_post: Optional[str] = None,
    reddit_post: Optional[str] = None,
):
    entry = Blog(
        user_id=user_id,
        topic=[Blog.make_entry(topic)] if topic else [],
        company_url=company_url,
        email_id=email_id,
        brand_name=brand_name,
        blogs=[Blog.make_entry(blog)] if blog else [],
        status=status,
        twitter_post=[Blog.make_entry(twitter_post)] if twitter_post else [],
        linkedin_post=[Blog.make_entry(linkedin_post)] if linkedin_post else [],
        reddit_post=[Blog.make_entry(reddit_post)] if reddit_post else [],
    )
    session.add(entry)
    session.flush()  # populate autogenerated fields
    return entry


def get_blog_by_id(session, blog_id):
    return session.query(Blog).filter(Blog.id == blog_id).one_or_none()


def update_blog_status(session, blog_id, *, status, blog_content=None, topic: Optional[str] = None):
    blog = get_blog_by_id(session, blog_id)
    if not blog:
        raise ValueError(f"Blog with id {blog_id} not found")

    blog.status = status
    if blog_content is not None:
        blogs = Blog.ensure_entries(blog.blogs)
        entry = Blog.make_entry(blog_content)
        blogs.append(entry)
        blog.blogs = blogs

    if topic:
        topics = Blog.ensure_entries(blog.topic)
        contents = Blog.entry_contents(topics)
        if topic not in contents:
            topics.append(Blog.make_entry(topic))
            blog.topic = topics

    session.add(blog)
    session.flush()
    return blog


def append_social_post(session, blog: Blog, platform: str, content: str):
    platform = platform.lower()
    entry = Blog.make_entry(content)
    if platform == "twitter":
        posts = Blog.ensure_entries(blog.twitter_post)
        posts.append(entry)
        blog.twitter_post = posts
    elif platform == "linkedin":
        posts = Blog.ensure_entries(blog.linkedin_post)
        posts.append(entry)
        blog.linkedin_post = posts
    elif platform == "reddit":
        posts = Blog.ensure_entries(blog.reddit_post)
        posts.append(entry)
        blog.reddit_post = posts
    else:
        raise ValueError(f"Unsupported platform for saving: {platform}")

    session.add(blog)
    session.flush()
    return blog
